<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Drone Flight Simulator - 20 Drones</title>
    <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" />
    <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/socket.io/4.7.5/socket.io.min.js"></script>
    <style>
        body { margin: 0; }
        #map { height: 100vh; width: 100%; }
        .drone-marker { font-size: 12px; }
    </style>
</head>
<body>
    <div id="map"></div>

    <script>
        const map = L.map('map').setView([35.08, 129.08], 12);
        L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
            attribution: '&copy; OpenStreetMap contributors'
        }).addTo(map);

        const markers = {};

        function updateUI(data) {
            if (!data || Object.keys(data).length === 0) {
                console.warn('No telemetry data received');
                return;
            }

            Object.entries(data).forEach(([port, tel]) => {
                const lat = parseFloat(tel.lat);
                const lon = parseFloat(tel.lon);
                
                if (isNaN(lat) || isNaN(lon) || lat === 0 || lon === 0) {
                    console.warn(`Invalid coordinates for Drone ${port - 14999}: lat=${lat}, lon=${lon}`);
                    return;
                }

                const status = tel.flight_status === 1 ? 'Flying' : 'Grounded';
                const color = status === 'Flying' ? 'green' : 'red';

                if (!markers[port]) {
                    markers[port] = L.marker([lat, lon], {
                        icon: L.divIcon({
                            className: 'drone-marker',
                            html: `<div style="background:${color};width:10px;height:10px;border-radius:50%;"></div>`
                        })
                    }).bindTooltip(`Drone ${port - 14999}`, { permanent: false }).addTo(map);
                    console.log(`Created marker for Drone ${port - 14999} at [${lat}, ${lon}]`);
                } else {
                    markers[port].setLatLng([lat, lon]);
                    markers[port].setIcon(L.divIcon({
                        className: 'drone-marker',
                        html: `<div style="background:${color};width:10px;height:10px;border-radius:50%;"></div>`
                    }));
                }
            });
        }

        const socket = io.connect('http://localhost:5000');
        socket.on('connect', () => {
            console.log('Connected to WebSocket');
        });
        socket.on('telemetry_update', (data) => {
            console.log('Received telemetry update:', Object.keys(data).length, 'drones');
            updateUI(data);
        });
        socket.on('disconnect', () => {
            console.warn('Disconnected from WebSocket');
        });
    </script>
</body>
</html>